name: E2E Tests

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Show Xcode version
        run: xcodebuild -version

      - uses: irgaly/xcode-cache@v1
        with:
          key: xcode-cache-deriveddata-${{ github.workflow }}-${{ github.sha }}
          restore-keys: xcode-cache-deriveddata-${{ github.workflow }}-

      - uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Install Bundled Gems
        run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Install Pods
        run: |
          bundle exec pod install

      - name: Build for Simulator
        run: |
          bundle exec fastlane build_for_simulator

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ./.node-version

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: "**/node_modules"
          key: ${{ runner.OS }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.OS }}-npm-

      - name: Run npm install
        run: npm ci
        shell: bash
        working-directory: ./e2e

      - name: Run Appium server
        run: |
          npx appium --base-path / &> appium.log &
        shell: bash
        working-directory: ./e2e

      - name: Boot simulator
        run: |
          xcrun simctl boot "iPhone 16"
        shell: bash

      - name: Install app
        run: |
          xcrun simctl install booted "SpoolDays.xcarchive/Products/Applications/SpoolDays.app"
        shell: bash

      - name: Run on simulator
        id: appium
        run: |
          npx tsx spool-days.spec.ts
        shell: bash
        working-directory: e2e/specs
        env:
          IOS_DEVICE_NAME: "iPhone 16"
          IOS_PLATFORM_VERSION: "18.2"
        continue-on-error: true

      - name: Show Appium log
        run: cat e2e/appium.log
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: images
          path: e2e/specs/images
